<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Loki Mode Dashboard - Multi-agent autonomous system monitor">
    <meta name="theme-color" content="#d97757">
    <title>Loki Mode Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23d97757' rx='15' width='100' height='100'/><text x='50' y='72' font-size='60' font-weight='bold' text-anchor='middle' fill='white'>L</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           Anthropic Design Language - Light & Dark
           Based on anthropic.com color system
           ============================================ */
        :root {
            /* Light Mode (default) - Anthropic cream theme */
            --bg-primary: #faf9f0;
            --bg-secondary: #f5f4eb;
            --bg-tertiary: #eeeddf;
            --bg-card: #ffffff;
            --bg-hover: #f0efe6;
            --accent: #d97757;
            --accent-light: #e8956f;
            --accent-muted: rgba(217, 119, 87, 0.12);
            --text-primary: #1a1a1a;
            --text-secondary: #5c5c5c;
            --text-muted: #8a8a8a;
            --border: #e5e3de;
            --border-light: #d4d2cb;

            /* Status Colors */
            --green: #16a34a;
            --green-muted: rgba(22, 163, 74, 0.12);
            --yellow: #ca8a04;
            --yellow-muted: rgba(202, 138, 4, 0.12);
            --red: #dc2626;
            --red-muted: rgba(220, 38, 38, 0.12);
            --blue: #2563eb;
            --blue-muted: rgba(37, 99, 235, 0.12);
            --purple: #9333ea;
            --purple-muted: rgba(147, 51, 234, 0.12);

            /* Model Colors */
            --opus: #d97706;
            --sonnet: #4f46e5;
            --haiku: #059669;

            /* Transition */
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            /* Dark Mode - Anthropic dark theme */
            --bg-primary: #131314;
            --bg-secondary: #1a1a1b;
            --bg-tertiary: #232325;
            --bg-card: #1e1e20;
            --bg-hover: #2a2a2d;
            --accent: #d97757;
            --accent-light: #e8956f;
            --accent-muted: rgba(217, 119, 87, 0.15);
            --text-primary: #f5f5f5;
            --text-secondary: #a1a1a6;
            --text-muted: #6b6b70;
            --border: #2d2d30;
            --border-light: #3d3d42;

            --green: #22c55e;
            --green-muted: rgba(34, 197, 94, 0.15);
            --yellow: #eab308;
            --yellow-muted: rgba(234, 179, 8, 0.15);
            --red: #ef4444;
            --red-muted: rgba(239, 68, 68, 0.15);
            --blue: #3b82f6;
            --blue-muted: rgba(59, 130, 246, 0.15);
            --purple: #a855f7;
            --purple-muted: rgba(168, 85, 247, 0.15);

            --opus: #f59e0b;
            --sonnet: #6366f1;
            --haiku: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            transition: background var(--transition), color var(--transition);
        }

        /* Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: background var(--transition), border-color var(--transition);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 8px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
        }

        .logo-version {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .theme-toggle-btn {
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            border: none;
            cursor: pointer;
            position: relative;
            transition: background var(--transition);
        }

        .theme-toggle-btn::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--bg-card);
            border-radius: 50%;
            transition: transform var(--transition);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] .theme-toggle-btn {
            background: var(--accent);
        }

        [data-theme="dark"] .theme-toggle-btn::after {
            transform: translateX(20px);
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--red);
        }

        .connection-dot.connected {
            background: var(--green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar Navigation */
        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sidebar-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 0 12px 4px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .sidebar-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: var(--accent-muted);
            color: var(--accent);
        }

        .sidebar-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 1.5;
            fill: none;
        }

        /* Status Panel */
        .status-panel {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: background var(--transition);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .status-label {
            color: var(--text-secondary);
        }

        .status-value {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.active { background: var(--green); animation: pulse 2s infinite; }
        .status-dot.idle { background: var(--text-muted); }
        .status-dot.paused { background: var(--yellow); }
        .status-dot.stopped { background: var(--red); }
        .status-dot.error { background: var(--red); }
        .status-dot.offline { background: var(--text-muted); }

        /* Intervention Controls */
        .intervention-controls {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .intervention-btn {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .intervention-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .intervention-btn.pause:hover {
            background: var(--yellow-muted);
            color: var(--yellow);
            border-color: var(--yellow);
        }

        .intervention-btn.stop:hover {
            background: var(--red-muted);
            color: var(--red);
            border-color: var(--red);
        }

        /* Main Content */
        .main-content {
            padding: 20px 24px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header-title {
            font-size: 22px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            transition: all var(--transition);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-change {
            font-size: 11px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive { color: var(--green); }
        .stat-change.negative { color: var(--red); }

        /* Kanban Board */
        .kanban-container {
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            min-height: 350px;
        }

        .kanban-column {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            transition: background var(--transition);
        }

        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .kanban-column.pending .kanban-column-header { border-color: var(--text-muted); }
        .kanban-column.in-progress .kanban-column-header { border-color: var(--blue); }
        .kanban-column.review .kanban-column-header { border-color: var(--purple); }
        .kanban-column.completed .kanban-column-header { border-color: var(--green); }

        .kanban-column-title {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kanban-column-count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .kanban-tasks {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 80px;
            transition: background var(--transition);
            border-radius: 6px;
            padding: 4px;
        }

        .kanban-tasks.drag-over {
            background: var(--bg-hover);
        }

        .task-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            cursor: grab;
            transition: all var(--transition);
        }

        .task-card:hover {
            border-color: var(--border-light);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .task-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .task-card.from-server {
            border-left: 3px solid var(--accent);
        }

        .task-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .task-id {
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
        }

        .task-priority {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .task-priority.high {
            background: var(--red-muted);
            color: var(--red);
        }

        .task-priority.medium {
            background: var(--yellow-muted);
            color: var(--yellow);
        }

        .task-priority.low {
            background: var(--green-muted);
            color: var(--green);
        }

        .task-title {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .task-type {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .add-task-btn {
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 6px;
            padding: 10px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
        }

        .add-task-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-muted);
        }

        /* Agents Grid */
        .agents-section {
            margin-bottom: 24px;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .agent-card:hover {
            border-color: var(--border-light);
            transform: translateY(-1px);
        }

        .agent-card.from-server {
            border-left: 3px solid var(--green);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .agent-info h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
            font-family: 'JetBrains Mono', monospace;
        }

        .agent-type {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .model-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .model-badge.opus {
            background: rgba(217, 119, 6, 0.12);
            color: var(--opus);
        }

        .model-badge.sonnet {
            background: rgba(79, 70, 229, 0.12);
            color: var(--sonnet);
        }

        .model-badge.haiku {
            background: rgba(5, 150, 105, 0.12);
            color: var(--haiku);
        }

        .agent-work {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .agent-stats {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .agent-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 11px;
        }

        .agent-status.active { color: var(--green); }
        .agent-status.idle { color: var(--text-muted); }
        .agent-status.completed { color: var(--purple); }
        .agent-status.error { color: var(--red); }

        /* System Grid */
        .system-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .system-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            transition: all var(--transition);
        }

        .system-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .system-card-title {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .system-card-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .system-card-status.healthy {
            background: var(--green-muted);
            color: var(--green);
        }

        .system-card-status.warning {
            background: var(--yellow-muted);
            color: var(--yellow);
        }

        /* RARV Cycle */
        .rarv-cycle {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .rarv-step {
            flex: 1;
            text-align: center;
            padding: 10px 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            position: relative;
            transition: all var(--transition);
        }

        .rarv-step.active {
            background: var(--accent-muted);
            color: var(--accent);
        }

        .rarv-step::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid var(--text-muted);
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }

        .rarv-step:last-child::after {
            display: none;
        }

        /* Memory Bars */
        .memory-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .memory-bar {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .memory-bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .memory-bar-label {
            color: var(--text-secondary);
        }

        .memory-bar-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        .memory-bar-track {
            height: 5px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }

        .memory-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .memory-bar-fill.episodic { background: var(--blue); }
        .memory-bar-fill.semantic { background: var(--purple); }
        .memory-bar-fill.procedural { background: var(--green); }

        /* Quality Gates */
        .quality-gates {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .quality-gate {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            font-size: 11px;
        }

        .gate-icon {
            width: 14px;
            height: 14px;
        }

        .gate-icon.pass { color: var(--green); }
        .gate-icon.fail { color: var(--red); }
        .gate-icon.pending { color: var(--yellow); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        [data-theme="dark"] .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            padding: 20px;
            transform: scale(0.95);
            transition: transform var(--transition);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            transition: border-color var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 70px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .system-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 1200px) {
            .kanban-board { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 1024px) {
            .dashboard { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .mobile-header { display: flex !important; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        .mobile-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .mobile-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }

        .mobile-logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
        }

        .mobile-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mobile-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .main-content { padding: 16px; }
            .kanban-board { grid-template-columns: 1fr; }
            .system-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: 1fr; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

        /* Terminal Output Panel */
        .terminal-section {
            margin-bottom: 24px;
        }

        .terminal-container {
            background: #1a1a1b;
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #232325;
            border-bottom: 1px solid var(--border);
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #a1a1a6;
        }

        .terminal-dots {
            display: flex;
            gap: 6px;
        }

        .terminal-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }

        .terminal-controls {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            padding: 4px 10px;
            background: #2a2a2d;
            border: 1px solid #3d3d42;
            border-radius: 4px;
            color: #a1a1a6;
            font-size: 11px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .terminal-btn:hover {
            background: #3d3d42;
            color: #f5f5f5;
        }

        .terminal-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .terminal-output {
            padding: 14px;
            max-height: 350px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #e5e5e5;
            background: #1a1a1b;
        }

        .terminal-line {
            display: flex;
            gap: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .terminal-line .timestamp {
            color: #6b6b70;
            flex-shrink: 0;
        }

        .terminal-line .level-info { color: #3b82f6; }
        .terminal-line .level-success { color: #22c55e; }
        .terminal-line .level-warning { color: #eab308; }
        .terminal-line .level-error { color: #ef4444; }
        .terminal-line .level-step { color: #a855f7; }
        .terminal-line .level-agent { color: #d97757; }

        .terminal-line .message {
            flex: 1;
        }

        .terminal-empty {
            color: #6b6b70;
            text-align: center;
            padding: 40px;
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .quick-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .quick-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .quick-action-btn.pause:hover {
            background: var(--yellow-muted);
            color: var(--yellow);
            border-color: var(--yellow);
        }

        .quick-action-btn.resume:hover {
            background: var(--green-muted);
            color: var(--green);
            border-color: var(--green);
        }

        .quick-action-btn.github:hover {
            background: var(--purple-muted);
            color: var(--purple);
            border-color: var(--purple);
        }

        .quick-action-btn.export:hover {
            background: var(--blue-muted);
            color: var(--blue);
            border-color: var(--blue);
        }

        /* GitHub Import Modal */
        .github-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .github-preview {
            margin-top: 14px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .github-preview-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .github-issue-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .github-issue-item:last-child {
            border-bottom: none;
        }

        .github-issue-number {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-weight: 500;
        }

        .github-issue-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .quick-actions {
                flex-wrap: wrap;
            }
            .quick-action-btn {
                flex: 1 1 45%;
            }
            .github-form .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Header (visible on small screens) -->
    <div class="mobile-header">
        <div class="mobile-logo">
            <div class="mobile-logo-icon">L</div>
            Loki Mode
        </div>
        <div class="mobile-controls">
            <div class="mobile-status">
                <span class="connection-dot" id="mobile-connection-dot"></span>
                <span id="mobile-mode-text">--</span>
            </div>
            <button class="theme-toggle-btn" id="mobile-theme-toggle" aria-label="Toggle theme"></button>
        </div>
    </div>

    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">L</div>
                <div>
                    <div class="logo-text">Loki Mode</div>
                    <div class="logo-version" id="version">v4.1.0</div>
                </div>
            </div>

            <!-- Theme Toggle -->
            <div class="theme-toggle">
                <span>Theme</span>
                <button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle theme"></button>
            </div>

            <!-- Connection Status -->
            <div class="connection-status">
                <span class="connection-dot" id="connection-dot"></span>
                <span id="connection-text">Connecting...</span>
            </div>
            <div class="connection-status" style="font-size: 10px; margin-top: -10px;">
                <span id="last-sync">Last sync: --</span>
            </div>

            <!-- Navigation -->
            <nav class="sidebar-section">
                <div class="sidebar-title">Navigation</div>
                <div class="sidebar-item active" data-section="kanban">
                    <svg class="sidebar-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                    Kanban Board
                </div>
                <div class="sidebar-item" data-section="agents">
                    <svg class="sidebar-icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 10-16 0"/></svg>
                    Active Agents
                </div>
                <div class="sidebar-item" data-section="system">
                    <svg class="sidebar-icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    System Status
                </div>
                <div class="sidebar-item" data-section="terminal">
                    <svg class="sidebar-icon" viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                    Terminal Output
                </div>
            </nav>

            <!-- Status Panel -->
            <div class="status-panel">
                <div class="sidebar-title" style="padding: 0; margin-bottom: 4px;">System Status</div>
                <div class="status-row">
                    <span class="status-label">Mode</span>
                    <span class="status-value">
                        <span class="status-dot offline" id="mode-dot"></span>
                        <span id="mode-text">OFFLINE</span>
                    </span>
                </div>
                <div class="status-row">
                    <span class="status-label">Phase</span>
                    <span class="status-value" id="phase-text">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Complexity</span>
                    <span class="status-value" id="complexity-text">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Iteration</span>
                    <span class="status-value" id="iteration-text">--</span>
                </div>
                <div class="intervention-controls">
                    <button class="intervention-btn pause" onclick="triggerPause()">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        PAUSE
                    </button>
                    <button class="intervention-btn stop" onclick="triggerStop()">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                        STOP
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="sidebar-section">
                <div class="sidebar-title">Resources</div>
                <div class="status-panel" style="gap: 6px;">
                    <div class="status-row">
                        <span class="status-label">CPU</span>
                        <span class="status-value" id="cpu-usage">--%</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Memory</span>
                        <span class="status-value" id="mem-usage">--%</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="header-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportTasks()">
                        <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                        Export
                    </button>
                    <button class="btn btn-primary" onclick="openAddTaskModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Task
                    </button>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Total Tasks</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">In Progress</div>
                    <div class="stat-value" id="stat-progress">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" id="stat-completed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Agents</div>
                    <div class="stat-value" id="stat-agents">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Failed</div>
                    <div class="stat-value" id="stat-failed">0</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn pause" onclick="triggerPause()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                    Pause All
                </button>
                <button class="quick-action-btn resume" onclick="triggerResume()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Resume
                </button>
                <button class="quick-action-btn github" onclick="openGitHubModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    Import GitHub
                </button>
                <button class="quick-action-btn export" onclick="exportTasks()">
                    <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    Export Report
                </button>
            </div>

            <!-- Kanban Board -->
            <div class="kanban-container" id="section-kanban">
                <div class="section-header">
                    <h2 class="section-title">Task Queue</h2>
                </div>
                <div class="kanban-board" id="kanban-board">
                    <div class="kanban-column pending" data-status="pending">
                        <div class="kanban-column-header">
                            <span class="kanban-column-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg>
                                Pending
                            </span>
                            <span class="kanban-column-count" id="pending-count">0</span>
                        </div>
                        <div class="kanban-tasks" id="pending-tasks"></div>
                        <button class="add-task-btn" onclick="openAddTaskModal('pending')">+ Add Task</button>
                    </div>
                    <div class="kanban-column in-progress" data-status="in-progress">
                        <div class="kanban-column-header">
                            <span class="kanban-column-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" stroke="var(--blue)" stroke-width="2" fill="none"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                                In Progress
                            </span>
                            <span class="kanban-column-count" id="in-progress-count">0</span>
                        </div>
                        <div class="kanban-tasks" id="in-progress-tasks"></div>
                    </div>
                    <div class="kanban-column review" data-status="review">
                        <div class="kanban-column-header">
                            <span class="kanban-column-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" stroke="var(--purple)" stroke-width="2" fill="none"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                In Review
                            </span>
                            <span class="kanban-column-count" id="review-count">0</span>
                        </div>
                        <div class="kanban-tasks" id="review-tasks"></div>
                    </div>
                    <div class="kanban-column completed" data-status="completed">
                        <div class="kanban-column-header">
                            <span class="kanban-column-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" stroke="var(--green)" stroke-width="2" fill="none"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                Completed
                            </span>
                            <span class="kanban-column-count" id="completed-count">0</span>
                        </div>
                        <div class="kanban-tasks" id="completed-tasks"></div>
                    </div>
                </div>
            </div>

            <!-- Active Agents -->
            <div class="agents-section" id="section-agents">
                <div class="section-header">
                    <h2 class="section-title">Active Agents</h2>
                </div>
                <div class="agents-grid" id="agents-grid">
                    <div class="empty-state">No active agents. Agents will appear when Loki Mode is running.</div>
                </div>
            </div>

            <!-- System Components -->
            <div class="system-grid" id="section-system">
                <!-- RARV Cycle -->
                <div class="system-card">
                    <div class="system-card-header">
                        <span class="system-card-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                            RARV Cycle
                        </span>
                        <span class="system-card-status healthy" id="rarv-status">Active</span>
                    </div>
                    <div class="rarv-cycle">
                        <div class="rarv-step" id="rarv-reason">Reason</div>
                        <div class="rarv-step" id="rarv-act">Act</div>
                        <div class="rarv-step" id="rarv-reflect">Reflect</div>
                        <div class="rarv-step" id="rarv-verify">Verify</div>
                    </div>
                </div>

                <!-- Memory System -->
                <div class="system-card">
                    <div class="system-card-header">
                        <span class="system-card-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                            Memory System
                        </span>
                        <span class="system-card-status healthy">Healthy</span>
                    </div>
                    <div class="memory-bars">
                        <div class="memory-bar">
                            <div class="memory-bar-header">
                                <span class="memory-bar-label">Episodic</span>
                                <span class="memory-bar-value" id="memory-episodic">0 entries</span>
                            </div>
                            <div class="memory-bar-track">
                                <div class="memory-bar-fill episodic" id="memory-episodic-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="memory-bar">
                            <div class="memory-bar-header">
                                <span class="memory-bar-label">Semantic</span>
                                <span class="memory-bar-value" id="memory-semantic">0 patterns</span>
                            </div>
                            <div class="memory-bar-track">
                                <div class="memory-bar-fill semantic" id="memory-semantic-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="memory-bar">
                            <div class="memory-bar-header">
                                <span class="memory-bar-label">Procedural</span>
                                <span class="memory-bar-value" id="memory-procedural">0 skills</span>
                            </div>
                            <div class="memory-bar-track">
                                <div class="memory-bar-fill procedural" id="memory-procedural-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality Gates -->
                <div class="system-card">
                    <div class="system-card-header">
                        <span class="system-card-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            Quality Gates
                        </span>
                        <span class="system-card-status healthy" id="quality-status">--</span>
                    </div>
                    <div class="quality-gates" id="quality-gates">
                        <div class="quality-gate"><svg class="gate-icon pending" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg> Static Analysis</div>
                        <div class="quality-gate"><svg class="gate-icon pending" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg> 3-Reviewer</div>
                        <div class="quality-gate"><svg class="gate-icon pending" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg> Anti-Sycophancy</div>
                        <div class="quality-gate"><svg class="gate-icon pending" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg> Test Coverage</div>
                        <div class="quality-gate"><svg class="gate-icon pending" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg> Security Scan</div>
                        <div class="quality-gate"><svg class="gate-icon pending" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/></svg> Performance</div>
                    </div>
                </div>
            </div>

            <!-- Terminal Output -->
            <div class="terminal-section" id="section-terminal">
                <div class="section-header">
                    <h2 class="section-title">Terminal Output</h2>
                </div>
                <div class="terminal-container">
                    <div class="terminal-header">
                        <div class="terminal-title">
                            <div class="terminal-dots">
                                <span class="terminal-dot red"></span>
                                <span class="terminal-dot yellow"></span>
                                <span class="terminal-dot green"></span>
                            </div>
                            loki-mode -- agent output
                        </div>
                        <div class="terminal-controls">
                            <button class="terminal-btn active" id="terminal-auto-scroll" onclick="toggleAutoScroll()">Auto-scroll</button>
                            <button class="terminal-btn" onclick="clearTerminal()">Clear</button>
                            <button class="terminal-btn" onclick="downloadLogs()">Download</button>
                        </div>
                    </div>
                    <div class="terminal-output" id="terminal-output">
                        <div class="terminal-empty">No log output yet. Terminal will update when Loki Mode is running.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="add-task-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button class="modal-close" onclick="closeAddTaskModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form onsubmit="addTask(event)">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input type="text" class="form-input" id="task-title" placeholder="e.g., Implement user authentication" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="task-description" placeholder="Describe what needs to be done..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="task-type">
                        <option value="eng-backend">Engineering - Backend</option>
                        <option value="eng-frontend">Engineering - Frontend</option>
                        <option value="eng-database">Engineering - Database</option>
                        <option value="qa-testing">QA - Testing</option>
                        <option value="ops-devops">Operations - DevOps</option>
                        <option value="security">Security</option>
                        <option value="docs">Documentation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-select" id="task-priority">
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <input type="hidden" id="task-initial-status" value="pending">
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- GitHub Import Modal -->
    <div class="modal-overlay" id="github-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import from GitHub</h3>
                <button class="modal-close" onclick="closeGitHubModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <form class="github-form" onsubmit="importGitHubIssues(event)">
                <div class="form-group">
                    <label class="form-label">Repository</label>
                    <input type="text" class="form-input" id="github-repo" placeholder="owner/repo (leave empty for auto-detect)">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Labels (comma-separated)</label>
                        <input type="text" class="form-input" id="github-labels" placeholder="bug,enhancement">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Milestone</label>
                        <input type="text" class="form-input" id="github-milestone" placeholder="v1.0.0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Assignee</label>
                        <input type="text" class="form-input" id="github-assignee" placeholder="@me or username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Limit</label>
                        <input type="number" class="form-input" id="github-limit" value="20" min="1" max="100">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">State</label>
                    <select class="form-select" id="github-state">
                        <option value="open">Open issues only</option>
                        <option value="closed">Closed issues only</option>
                        <option value="all">All issues</option>
                    </select>
                </div>
                <div class="github-preview" id="github-preview" style="display: none;">
                    <div class="github-preview-title">Preview: <span id="github-preview-count">0</span> issues found</div>
                    <div id="github-preview-list"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="previewGitHubIssues()">Preview</button>
                    <button type="button" class="btn btn-secondary" onclick="closeGitHubModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // Configuration
        // ============================================
        const CONFIG = {
            POLL_INTERVAL: 2000,       // Poll every 2 seconds
            STATE_FILE: '../dashboard-state.json',
            LOCAL_STORAGE_KEY: 'loki-dashboard-local'
        };

        // ============================================
        // State Management
        // ============================================
        let serverState = null;
        let localState = {
            tasks: [],
            lastUpdated: null
        };
        let isConnected = false;
        let pollInterval = null;

        // ============================================
        // Theme Management
        // ============================================
        function initTheme() {
            const saved = localStorage.getItem('loki-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('loki-theme', next);
        }

        // ============================================
        // File-Based Sync (Realtime Polling)
        // ============================================
        async function fetchServerState() {
            try {
                const response = await fetch(CONFIG.STATE_FILE + '?t=' + Date.now());
                if (!response.ok) {
                    throw new Error('State file not found');
                }
                const data = await response.json();
                serverState = data;
                setConnected(true);
                updateUI();
                return data;
            } catch (error) {
                setConnected(false);
                // Keep showing local state if server unavailable
                if (localState.tasks.length > 0) {
                    renderKanban();
                }
                return null;
            }
        }

        function setConnected(connected) {
            isConnected = connected;
            const dot = document.getElementById('connection-dot');
            const text = document.getElementById('connection-text');
            const syncText = document.getElementById('last-sync');
            const mobileDot = document.getElementById('mobile-connection-dot');
            const mobileModeText = document.getElementById('mobile-mode-text');

            if (connected) {
                dot.classList.add('connected');
                mobileDot?.classList.add('connected');
                text.textContent = 'Live - syncing';
                syncText.textContent = 'Last sync: ' + new Date().toLocaleTimeString();
                if (mobileModeText && serverState) {
                    mobileModeText.textContent = serverState.mode?.toUpperCase() || 'LIVE';
                }
            } else {
                dot.classList.remove('connected');
                mobileDot?.classList.remove('connected');
                text.textContent = 'Offline - local only';
                if (mobileModeText) {
                    mobileModeText.textContent = 'OFFLINE';
                }
            }
        }

        function startPolling() {
            fetchServerState();
            fetchTerminalLogs();
            pollInterval = setInterval(() => {
                fetchServerState();
                fetchTerminalLogs();
            }, CONFIG.POLL_INTERVAL);
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
        }

        // ============================================
        // Local Storage
        // ============================================
        function loadLocalState() {
            const saved = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
            if (saved) {
                localState = JSON.parse(saved);
            }
        }

        function saveLocalState() {
            localState.lastUpdated = Date.now();
            localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, JSON.stringify(localState));
        }

        // ============================================
        // UI Update Functions
        // ============================================
        function updateUI() {
            if (!serverState) return;

            // Update version
            document.getElementById('version').textContent = 'v' + (serverState.version || '4.1.0');

            // Update status panel
            updateStatusPanel();

            // Update stats
            updateStats();

            // Render kanban with merged tasks
            renderKanban();

            // Render agents
            renderAgents();

            // Update system components
            updateSystemComponents();
        }

        function updateStatusPanel() {
            if (!serverState) return;

            const modeMap = {
                'autonomous': { text: 'AUTONOMOUS', class: 'active' },
                'paused': { text: 'PAUSED', class: 'paused' },
                'stopped': { text: 'STOPPED', class: 'stopped' }
            };

            const mode = modeMap[serverState.mode] || modeMap['autonomous'];
            document.getElementById('mode-text').textContent = mode.text;
            document.getElementById('mode-dot').className = 'status-dot ' + mode.class;

            document.getElementById('phase-text').textContent = serverState.phase || '--';
            document.getElementById('complexity-text').textContent = (serverState.complexity || '--').toUpperCase();
            document.getElementById('iteration-text').textContent = serverState.iteration || '--';

            // Resources
            document.getElementById('cpu-usage').textContent = (serverState.metrics?.cpuUsage || 0) + '%';
            document.getElementById('mem-usage').textContent = (serverState.metrics?.memoryUsage || 0) + '%';
        }

        function updateStats() {
            const tasks = serverState?.tasks || {};
            const pending = tasks.pending?.length || 0;
            const inProgress = tasks.inProgress?.length || 0;
            const review = tasks.review?.length || 0;
            const completed = tasks.completed?.length || 0;
            const failed = tasks.failed?.length || 0;
            const total = pending + inProgress + review + completed + failed + localState.tasks.length;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-progress').textContent = inProgress;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-failed').textContent = failed;
            document.getElementById('stat-agents').textContent = serverState?.agents?.length || 0;
        }

        // ============================================
        // Kanban Rendering
        // ============================================
        function renderKanban() {
            const columns = {
                pending: document.getElementById('pending-tasks'),
                'in-progress': document.getElementById('in-progress-tasks'),
                review: document.getElementById('review-tasks'),
                completed: document.getElementById('completed-tasks')
            };

            // Clear columns
            Object.values(columns).forEach(col => col.innerHTML = '');

            // Render server tasks
            if (serverState?.tasks) {
                renderTasksToColumn(serverState.tasks.pending || [], columns.pending, true);
                renderTasksToColumn(serverState.tasks.inProgress || [], columns['in-progress'], true);
                renderTasksToColumn(serverState.tasks.review || [], columns.review, true);
                renderTasksToColumn(serverState.tasks.completed || [], columns.completed, true);
            }

            // Render local tasks
            localState.tasks.forEach(task => {
                const column = columns[task.status];
                if (column) {
                    renderTaskCard(task, column, false);
                }
            });

            // Update counts
            updateCounts();

            // Setup drag-drop
            setupDragDrop();
        }

        function renderTasksToColumn(tasks, column, fromServer) {
            tasks.forEach(task => renderTaskCard(task, column, fromServer));
        }

        function renderTaskCard(task, column, fromServer) {
            const card = document.createElement('div');
            card.className = 'task-card' + (fromServer ? ' from-server' : '');
            card.draggable = !fromServer; // Only local tasks are draggable
            card.dataset.taskId = task.id;
            card.dataset.fromServer = fromServer;

            const priority = task.priority || 'medium';
            const type = task.type || 'unknown';

            card.innerHTML = `
                <div class="task-card-header">
                    <span class="task-id">${task.id || 'local-' + Date.now()}</span>
                    <span class="task-priority ${priority}">${priority}</span>
                </div>
                <div class="task-title">${task.title || task.description || 'Untitled'}</div>
                <div class="task-meta">
                    <span class="task-type">${type}</span>
                    ${task.agent ? `<span>${task.agent}</span>` : ''}
                </div>
            `;

            if (!fromServer) {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            }

            column.appendChild(card);
        }

        function updateCounts() {
            const serverTasks = serverState?.tasks || {};
            const localByStatus = {
                pending: localState.tasks.filter(t => t.status === 'pending').length,
                'in-progress': localState.tasks.filter(t => t.status === 'in-progress').length,
                review: localState.tasks.filter(t => t.status === 'review').length,
                completed: localState.tasks.filter(t => t.status === 'completed').length
            };

            document.getElementById('pending-count').textContent =
                (serverTasks.pending?.length || 0) + localByStatus.pending;
            document.getElementById('in-progress-count').textContent =
                (serverTasks.inProgress?.length || 0) + localByStatus['in-progress'];
            document.getElementById('review-count').textContent =
                (serverTasks.review?.length || 0) + localByStatus.review;
            document.getElementById('completed-count').textContent =
                (serverTasks.completed?.length || 0) + localByStatus.completed;
        }

        // ============================================
        // Drag and Drop
        // ============================================
        let draggedTask = null;

        function handleDragStart(e) {
            draggedTask = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-tasks').forEach(col => col.classList.remove('drag-over'));
            draggedTask = null;
        }

        function setupDragDrop() {
            document.querySelectorAll('.kanban-tasks').forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                zone.addEventListener('dragenter', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', e => {
                    if (!zone.contains(e.relatedTarget)) {
                        zone.classList.remove('drag-over');
                    }
                });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = zone.closest('.kanban-column').dataset.status;

                    // Update local task status
                    const task = localState.tasks.find(t => t.id === taskId);
                    if (task && task.status !== newStatus) {
                        task.status = newStatus;
                        saveLocalState();
                        renderKanban();
                    }
                });
            });
        }

        // ============================================
        // Agents Rendering
        // ============================================
        function renderAgents() {
            const grid = document.getElementById('agents-grid');
            const agents = serverState?.agents || [];

            if (agents.length === 0) {
                grid.innerHTML = '<div class="empty-state">No active agents. Agents will appear when Loki Mode is running.</div>';
                return;
            }

            grid.innerHTML = agents.map(agent => `
                <div class="agent-card from-server">
                    <div class="agent-header">
                        <div class="agent-info">
                            <h3>${agent.id || 'unknown'}</h3>
                            <div class="agent-type">${agent.type || 'Agent'}</div>
                        </div>
                        <span class="model-badge ${(agent.model || 'sonnet').toLowerCase()}">${agent.model || 'sonnet'}</span>
                    </div>
                    <div class="agent-work">${agent.work || agent.currentTask || (agent.status === 'idle' ? 'Waiting for tasks...' : 'Working...')}</div>
                    <div class="agent-stats">
                        <span class="agent-stat">
                            <svg width="10" height="10" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            ${agent.runtime || '--'}
                        </span>
                        <span class="agent-stat">
                            <svg width="10" height="10" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            ${agent.tasks || 0} tasks
                        </span>
                    </div>
                    <div class="agent-status ${agent.status || 'active'}">
                        <span class="status-dot ${agent.status || 'active'}"></span>
                        ${agent.status === 'active' ? 'Active' : agent.status === 'idle' ? 'Idle' : agent.status === 'error' ? 'Error' : 'Completed'}
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // System Components
        // ============================================
        function updateSystemComponents() {
            if (!serverState) return;

            // RARV Cycle - supports both string step name and numeric index
            const rarvStepMap = { 'REASON': 0, 'ACT': 1, 'REFLECT': 2, 'VERIFY': 3 };
            let rarvStep = 0;
            if (serverState.rarv) {
                if (typeof serverState.rarv.currentStep === 'number') {
                    rarvStep = serverState.rarv.currentStep;
                } else if (typeof serverState.rarv.step === 'string') {
                    rarvStep = rarvStepMap[serverState.rarv.step.toUpperCase()] || 0;
                }
            }
            const rarvIds = ['rarv-reason', 'rarv-act', 'rarv-reflect', 'rarv-verify'];
            rarvIds.forEach((id, i) => {
                document.getElementById(id).classList.toggle('active', i === rarvStep);
            });

            // Memory System
            const memory = serverState.memory || {};
            const maxMemory = 100; // Assume max for percentage

            document.getElementById('memory-episodic').textContent = (memory.episodic || 0) + ' entries';
            document.getElementById('memory-episodic-bar').style.width = Math.min((memory.episodic || 0) / maxMemory * 100, 100) + '%';

            document.getElementById('memory-semantic').textContent = (memory.semantic || 0) + ' patterns';
            document.getElementById('memory-semantic-bar').style.width = Math.min((memory.semantic || 0) / maxMemory * 100, 100) + '%';

            document.getElementById('memory-procedural').textContent = (memory.procedural || 0) + ' skills';
            document.getElementById('memory-procedural-bar').style.width = Math.min((memory.procedural || 0) / maxMemory * 100, 100) + '%';

            // Quality Gates - render actual status from server
            const gates = serverState.qualityGates || {};
            const gateContainer = document.getElementById('quality-gates');
            const gateConfigs = [
                { key: 'staticAnalysis', label: 'Static Analysis' },
                { key: 'codeReview', label: '3-Reviewer' },
                { key: 'antiSycophancy', label: 'Anti-Sycophancy' },
                { key: 'testCoverage', label: 'Test Coverage' },
                { key: 'securityScan', label: 'Security Scan' },
                { key: 'performance', label: 'Performance' }
            ];

            gateContainer.innerHTML = gateConfigs.map(gate => {
                const status = gates[gate.key] || 'pending';
                const statusClass = status === 'passed' ? 'pass' :
                                   status === 'failed' ? 'fail' : 'pending';
                const icon = status === 'passed'
                    ? '<polyline points="22 4 12 14.01 9 11.01"/><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>'
                    : status === 'failed'
                    ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
                    : '<circle cx="12" cy="12" r="10"/>';
                return `<div class="quality-gate"><svg class="gate-icon ${statusClass}" width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">${icon}</svg> ${gate.label}</div>`;
            }).join('');

            // Update overall quality status
            const passedCount = Object.values(gates).filter(s => s === 'passed').length;
            const failedCount = Object.values(gates).filter(s => s === 'failed').length;
            const statusEl = document.getElementById('quality-status');
            if (failedCount > 0) {
                statusEl.textContent = failedCount + ' Failed';
                statusEl.className = 'system-card-status warning';
            } else if (passedCount === gateConfigs.length) {
                statusEl.textContent = 'All Passed';
                statusEl.className = 'system-card-status healthy';
            } else {
                statusEl.textContent = passedCount + '/' + gateConfigs.length;
                statusEl.className = 'system-card-status healthy';
            }
        }

        // ============================================
        // Task Management
        // ============================================
        function openAddTaskModal(initialStatus = 'pending') {
            document.getElementById('task-initial-status').value = initialStatus;
            document.getElementById('add-task-modal').classList.add('active');
        }

        function closeAddTaskModal() {
            document.getElementById('add-task-modal').classList.remove('active');
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
        }

        function addTask(e) {
            e.preventDefault();

            const newTask = {
                id: 'local-' + Date.now(),
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                type: document.getElementById('task-type').value,
                priority: document.getElementById('task-priority').value,
                status: document.getElementById('task-initial-status').value,
                createdAt: Date.now(),
                local: true
            };

            localState.tasks.push(newTask);
            saveLocalState();
            renderKanban();
            updateStats();
            closeAddTaskModal();
        }

        // ============================================
        // Human Intervention
        // ============================================
        function triggerPause() {
            alert('To pause Loki Mode, create this file:\ntouch .loki/PAUSE\n\nOr press Ctrl+C once in the terminal.');
        }

        function triggerStop() {
            alert('To stop Loki Mode, create this file:\ntouch .loki/STOP\n\nOr press Ctrl+C twice in the terminal.');
        }

        function triggerResume() {
            alert('To resume Loki Mode, remove the pause file:\nrm .loki/PAUSE\n\nOr use: loki resume');
        }

        // ============================================
        // Terminal Output
        // ============================================
        const MAX_TERMINAL_LINES = 1000;
        let terminalLines = [];
        let autoScroll = true;
        let lastLogPosition = 0;

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('terminal-auto-scroll');
            btn.classList.toggle('active', autoScroll);
            if (autoScroll) {
                scrollTerminalToBottom();
            }
        }

        function scrollTerminalToBottom() {
            const output = document.getElementById('terminal-output');
            output.scrollTop = output.scrollHeight;
        }

        function clearTerminal() {
            terminalLines = [];
            renderTerminal();
        }

        function downloadLogs() {
            const content = terminalLines.map(line =>
                `[${line.timestamp}] [${line.level.toUpperCase()}] ${line.message}`
            ).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'loki-mode-logs-' + Date.now() + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        function parseLogLine(line) {
            // Parse log format: [TIMESTAMP] [LEVEL] MESSAGE or similar
            const patterns = [
                /^\[(\d{2}:\d{2}:\d{2})\]\s*\[(\w+)\]\s*(.*)$/,
                /^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2})\s*\[(\w+)\]\s*(.*)$/,
                /^\[(\w+)\]\s*(.*)$/
            ];

            for (const pattern of patterns) {
                const match = line.match(pattern);
                if (match) {
                    if (match.length === 4) {
                        return { timestamp: match[1], level: match[2].toLowerCase(), message: match[3] };
                    } else if (match.length === 3) {
                        return { timestamp: new Date().toLocaleTimeString(), level: match[1].toLowerCase(), message: match[2] };
                    }
                }
            }

            // Default: treat as info
            return { timestamp: new Date().toLocaleTimeString(), level: 'info', message: line };
        }

        function getLevelClass(level) {
            const levelMap = {
                'info': 'level-info',
                'success': 'level-success',
                'warn': 'level-warning',
                'warning': 'level-warning',
                'error': 'level-error',
                'err': 'level-error',
                'step': 'level-step',
                'agent': 'level-agent',
                'debug': 'level-info'
            };
            return levelMap[level] || 'level-info';
        }

        function renderTerminal() {
            const output = document.getElementById('terminal-output');

            if (terminalLines.length === 0) {
                output.innerHTML = '<div class="terminal-empty">No log output yet. Terminal will update when Loki Mode is running.</div>';
                return;
            }

            output.innerHTML = terminalLines.map(line => `
                <div class="terminal-line">
                    <span class="timestamp">[${line.timestamp}]</span>
                    <span class="${getLevelClass(line.level)}">[${line.level.toUpperCase()}]</span>
                    <span class="message">${escapeHtml(line.message)}</span>
                </div>
            `).join('');

            if (autoScroll) {
                scrollTerminalToBottom();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function fetchTerminalLogs() {
            try {
                const response = await fetch('../logs/agent.log?t=' + Date.now());
                if (!response.ok) {
                    return;
                }
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim());

                // Only add new lines
                if (lines.length > terminalLines.length) {
                    const newLines = lines.slice(terminalLines.length);
                    newLines.forEach(line => {
                        terminalLines.push(parseLogLine(line));
                    });

                    // Limit memory growth - keep only the last MAX_TERMINAL_LINES
                    if (terminalLines.length > MAX_TERMINAL_LINES) {
                        terminalLines = terminalLines.slice(-MAX_TERMINAL_LINES);
                    }

                    renderTerminal();
                }
            } catch (error) {
                // Silently fail - log file may not exist yet
            }
        }

        // ============================================
        // GitHub Import
        // ============================================
        let githubPreviewIssues = [];

        // Sanitize shell arguments to prevent command injection
        function sanitizeShellArg(input) {
            if (!input) return '';
            // Remove dangerous shell metacharacters
            return input.replace(/[`$"\\!;&|><(){}[\]\n\r]/g, '').trim();
        }

        // Validate repository format (owner/repo)
        function validateRepoFormat(repo) {
            if (!repo) return true; // Empty is valid (auto-detect)
            return /^[a-zA-Z0-9_.-]+\/[a-zA-Z0-9_.-]+$/.test(repo);
        }

        function openGitHubModal() {
            document.getElementById('github-modal').classList.add('active');
            document.getElementById('github-preview').style.display = 'none';
            githubPreviewIssues = [];
        }

        function closeGitHubModal() {
            document.getElementById('github-modal').classList.remove('active');
            document.getElementById('github-repo').value = '';
            document.getElementById('github-labels').value = '';
            document.getElementById('github-milestone').value = '';
            document.getElementById('github-assignee').value = '';
            document.getElementById('github-preview').style.display = 'none';
            githubPreviewIssues = [];
        }

        function buildGitHubCommand() {
            const repo = sanitizeShellArg(document.getElementById('github-repo').value);
            const labels = sanitizeShellArg(document.getElementById('github-labels').value);
            const milestone = sanitizeShellArg(document.getElementById('github-milestone').value);
            const assignee = sanitizeShellArg(document.getElementById('github-assignee').value);
            const limitVal = parseInt(document.getElementById('github-limit').value, 10);
            const limit = Math.max(1, Math.min(100, isNaN(limitVal) ? 20 : limitVal));
            const state = document.getElementById('github-state').value;

            // Validate repo format if provided
            if (repo && !validateRepoFormat(repo)) {
                return { error: 'Invalid repository format. Use: owner/repo' };
            }

            let cmd = 'gh issue list --json number,title,body,labels,assignees,milestone --state ' + state + ' --limit ' + limit;

            if (repo) {
                cmd += ' --repo ' + repo;
            }
            if (labels) {
                labels.split(',').forEach(label => {
                    const sanitizedLabel = sanitizeShellArg(label);
                    if (sanitizedLabel) {
                        cmd += ' --label "' + sanitizedLabel + '"';
                    }
                });
            }
            if (milestone) {
                cmd += ' --milestone "' + milestone + '"';
            }
            if (assignee) {
                cmd += ' --assignee "' + assignee + '"';
            }

            return cmd;
        }

        async function previewGitHubIssues() {
            const previewDiv = document.getElementById('github-preview');
            const listDiv = document.getElementById('github-preview-list');
            const countSpan = document.getElementById('github-preview-count');

            // Show loading
            previewDiv.style.display = 'block';
            listDiv.innerHTML = '<div style="color: var(--text-muted);">Loading issues... (requires gh CLI)</div>';

            // In a real implementation, this would call the backend
            // For the dashboard, we show instructions
            const cmd = buildGitHubCommand();

            // Check for validation error
            if (cmd && cmd.error) {
                listDiv.innerHTML = `<div style="color: var(--red);">${escapeHtml(cmd.error)}</div>`;
                countSpan.textContent = '0';
                return;
            }

            listDiv.innerHTML = `
                <div style="color: var(--text-muted); font-size: 11px;">
                    <p style="margin-bottom: 8px;">To preview issues, run this command in terminal:</p>
                    <code style="display: block; background: #2a2a2d; padding: 8px; border-radius: 4px; word-break: break-all; color: #e5e5e5;">${escapeHtml(cmd)}</code>
                    <p style="margin-top: 8px;">Or use the CLI: <code>loki import --preview</code></p>
                </div>
            `;
            countSpan.textContent = '?';
        }

        function importGitHubIssues(e) {
            e.preventDefault();

            // Sanitize all inputs to prevent command injection
            const repo = sanitizeShellArg(document.getElementById('github-repo').value);
            const labels = sanitizeShellArg(document.getElementById('github-labels').value);
            const milestone = sanitizeShellArg(document.getElementById('github-milestone').value);
            const assignee = sanitizeShellArg(document.getElementById('github-assignee').value);
            const limitVal = parseInt(document.getElementById('github-limit').value, 10);
            const limit = Math.max(1, Math.min(100, isNaN(limitVal) ? 20 : limitVal));
            const state = document.getElementById('github-state').value;

            // Validate repo format
            if (repo && !validateRepoFormat(repo)) {
                alert('Invalid repository format. Use: owner/repo');
                return;
            }

            // Build the import command for the user
            let cliCmd = 'loki import';
            if (repo) cliCmd += ' --repo ' + repo;
            if (labels) cliCmd += ' --labels "' + labels + '"';
            if (milestone) cliCmd += ' --milestone "' + milestone + '"';
            if (assignee) cliCmd += ' --assignee "' + assignee + '"';
            if (limit !== 20) cliCmd += ' --limit ' + limit;
            if (state !== 'open') cliCmd += ' --state ' + state;

            // Also build env vars for run.sh
            let envSetup = 'export LOKI_GITHUB_IMPORT=true';
            if (repo) envSetup += '\nexport LOKI_GITHUB_REPO="' + repo + '"';
            if (labels) envSetup += '\nexport LOKI_GITHUB_LABELS="' + labels + '"';
            if (milestone) envSetup += '\nexport LOKI_GITHUB_MILESTONE="' + milestone + '"';
            if (assignee) envSetup += '\nexport LOKI_GITHUB_ASSIGNEE="' + assignee + '"';
            if (limit !== 20) envSetup += '\nexport LOKI_GITHUB_LIMIT=' + limit;

            const message = `To import GitHub issues, run one of these commands:

Option 1 - Using CLI:
${cliCmd}

Option 2 - Using environment variables:
${envSetup}

Then start Loki Mode and issues will be imported automatically.`;

            alert(message);
            closeGitHubModal();
        }

        // ============================================
        // Export
        // ============================================
        function exportTasks() {
            const exportData = {
                serverState: serverState,
                localState: localState,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'loki-mode-export-' + Date.now() + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================
        // Initialize
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadLocalState();
            startPolling();

            // Theme toggle (both desktop and mobile)
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('mobile-theme-toggle').addEventListener('click', toggleTheme);

            // Sidebar navigation - scroll to sections
            document.querySelectorAll('.sidebar-item[data-section]').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    const targetElement = document.getElementById('section-' + section);

                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // Update active state
                        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                    }
                });
            });

            // Scroll spy - update sidebar active state based on scroll position
            const sections = ['kanban', 'agents', 'system', 'terminal'];
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.addEventListener('scroll', () => {
                    let currentSection = 'kanban';
                    sections.forEach(section => {
                        const el = document.getElementById('section-' + section);
                        if (el && el.getBoundingClientRect().top < 200) {
                            currentSection = section;
                        }
                    });
                    document.querySelectorAll('.sidebar-item[data-section]').forEach(item => {
                        item.classList.toggle('active', item.dataset.section === currentSection);
                    });
                });
            }

            // Modal backdrop click
            document.getElementById('add-task-modal').addEventListener('click', e => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeAddTaskModal();
                }
            });

            document.getElementById('github-modal').addEventListener('click', e => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeGitHubModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    closeAddTaskModal();
                    closeGitHubModal();
                }
                if (e.key === 'n' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    openAddTaskModal();
                }
            });

            // Initial render with local data
            renderKanban();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>
